<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ejercicio de Navegación</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f8fafc; /* bg-slate-50 */
      color: #334155; /* text-slate-700 */
    }
    main {
      flex-grow: 1;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    header, footer {
        flex-shrink: 0;
    }
    @media (min-width: 768px) {
      #exercise-content {
        max-width: none !important;
        width: 100% !important;
        padding: 2.5rem 3rem !important;
      }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-700">

  <header class="bg-sky-700 shadow-sm">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <h1 id="exercise-page-title" class="text-xl md:text-2xl font-bold text-white">Ejercicio</h1>
      <a href="index.html" class="text-sm sm:text-base text-white hover:text-sky-100 font-medium px-3 py-2 sm:px-4 sm:py-2 rounded-md border border-white hover:bg-sky-600 transition-colors">&larr; Volver al Manual</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8">
    <div id="exercise-content" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
      <h2 id="exercise-topic-heading" class="text-2xl sm:text-3xl font-semibold text-slate-800 mb-6">Cargando ejercicio...</h2>
      <p id="exercise-description" class="text-slate-600 leading-relaxed text-sm sm:text-base">
        Por favor, espera mientras cargamos el contenido del ejercicio.
      </p>
      <!-- Actual exercise content would go here -->
      <div class="mt-8 pt-6 border-t border-slate-200">
        <p class="text-sm text-slate-500">Este es un ejercicio de ejemplo. En una aplicación real, aquí encontrarías preguntas interactivas, simulaciones o problemas a resolver relacionados con el tema.</p>
      </div>
    </div>
  </main>

  <footer class="bg-slate-100 border-t border-slate-200 mt-auto">
    <div class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-xs text-slate-500">© ${new Date().getFullYear()} Sailut. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const topicSlug = params.get('topic');
      const exercisePageTitleElement = document.getElementById('exercise-page-title');
      const topicHeadingElement = document.getElementById('exercise-topic-heading');
      const descriptionElement = document.getElementById('exercise-description');

      function formatTopicName(slug) {
        if (!slug) return "Desconocido";
        return slug
          .split('-')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }

      if (topicSlug && topicHeadingElement && descriptionElement && exercisePageTitleElement) {
        const formattedTopic = formatTopicName(topicSlug);
        exercisePageTitleElement.textContent = `Ejercicio: ${formattedTopic}`;
        topicHeadingElement.textContent = `Ejercicio sobre: ${formattedTopic}`;
        descriptionElement.textContent = `Aquí encontrarás un ejercicio interactivo relacionado con ${formattedTopic}. Completa las tareas y preguntas para poner a prueba tus conocimientos.`;

        // --- Ejercicio interactivo de rumbos ---
        if (topicSlug === 'rumbos') {
          const rumbos = [
            { name: 'Por la amura', pos: 0 },
            { name: 'A un descuartelar', pos: 1 },
            { name: 'Por el través', pos: 2 },
            { name: 'A un largo', pos: 3 },
            { name: 'Por la aleta', pos: 4 }
          ];
          // Mezclar los nombres para el drag
          const shuffled = [...rumbos].sort(() => Math.random() - 0.5);
          const container = document.getElementById('exercise-content');
          container.innerHTML = `
            <div class="flex flex-col md:flex-row gap-8">
              <div class="md:w-1/3 w-full">
                <h3 class="text-lg font-semibold mb-2">Ejercicio de rumbos según el viento</h3>
                <p class="mb-4 text-slate-600 text-sm">Arrastra cada nombre de rumbo hasta la posición correcta en el diagrama del velero, según la dirección desde la que sopla el viento.</p>
                <ul id="rumbos-list" class="space-y-3">
                  ${shuffled.map((r, i) => `
                    <li draggable="true" data-rumbo="${r.name}" class="draggable-rumbo cursor-move bg-slate-100 rounded px-4 py-4 shadow hover:bg-sky-100 transition text-lg touch-manipulation">${r.name}</li>`).join('')}
                </ul>
              </div>
              <div class="md:w-2/3 w-full flex justify-center items-center">
                <div class="relative w-[520px] h-[520px] mx-auto" id="rosa-rumbos">
                  <svg viewBox="0 0 520 520" width="100%" height="320" style="max-width: 100vw; touch-action: none;">
                    <g id="rumbos-zones">
                      ${(() => {
                        // 5 posiciones, ángulos: -90, -45, 0, 45, 90 (de arriba a abajo, sentido horario)
                        const angles = [-90, -45, 0, 45, 90];
                        return rumbos.map((r, i) => {
                          const angle = angles[i];
                          const rad = angle * Math.PI / 180;
                          // Centro del velero
                          const cx = 260;
                          const cy = 260;
                          // Flechas y drop-zones más lejos del centro
                          const x1 = cx + Math.cos(rad) * 90;
                          const y1 = cy + Math.sin(rad) * 90;
                          const x2 = cx + Math.cos(rad) * 210;
                          const y2 = cy + Math.sin(rad) * 210;
                          return `
                            <g>
                              <line x1="${x2}" y1="${y2}" x2="${x1}" y2="${y1}" stroke="#0ea5e9" stroke-width="2.5" marker-end="url(#arrowhead${i})"/>
                              <rect class="drop-zone" data-pos="${i}" x="${x2-60}" y="${y2-32}" width="120" height="64" rx="16" fill="#fff" stroke="#0369a1" stroke-width="2"/>
                            </g>
                          `;
                        }).join('');
                      })()}
                    </g>
                    <g id="velero">
                      <image href="assets/velero.png" x="185" y="120" width="150" height="300" />
                    </g>
                    <defs>
                      ${[0,1,2,3,4].map(i => `
                        <marker id="arrowhead${i}" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto" markerUnits="strokeWidth">
                          <polygon points="0,0 6,3 0,6" fill="#0ea5e9" />
                        </marker>
                      `).join('')}
                    </defs>
                  </svg>
                  <div id="labels-overlay" class="absolute inset-0 pointer-events-none"></div>
                </div>
              </div>
            </div>
          `;

          // Drag & Drop JS
          let dragged = null;
          let draggedText = '';
          // Drag & Drop para mouse
          document.querySelectorAll('.draggable-rumbo').forEach(el => {
            el.addEventListener('dragstart', e => {
              dragged = el;
              draggedText = el.getAttribute('data-rumbo');
              setTimeout(() => el.classList.add('opacity-50'), 0);
            });
            el.addEventListener('dragend', e => {
              dragged = null;
              draggedText = '';
              el.classList.remove('opacity-50');
            });
            // Touch events para móviles
            el.addEventListener('touchstart', e => {
              dragged = el;
              draggedText = el.getAttribute('data-rumbo');
              el.classList.add('opacity-50');
              e.stopPropagation();
            });
            el.addEventListener('touchend', e => {
              dragged = null;
              draggedText = '';
              el.classList.remove('opacity-50');
              e.stopPropagation();
            });
          });
          document.querySelectorAll('.drop-zone').forEach((zone, idx) => {
            zone.addEventListener('dragover', e => {
              e.preventDefault();
              zone.setAttribute('fill', '#bae6fd');
            });
            zone.addEventListener('dragleave', e => {
              zone.setAttribute('fill', '#fff');
            });
            zone.addEventListener('drop', e => {
              e.preventDefault();
              zone.setAttribute('fill', '#fff');
              if (!dragged) return;
              handleDropRumbo(zone, idx);
            });
            // Touch events para móviles
            zone.addEventListener('touchmove', e => {
              e.preventDefault();
              zone.setAttribute('fill', '#bae6fd');
            });
            zone.addEventListener('touchend', e => {
              zone.setAttribute('fill', '#fff');
              if (!dragged) return;
              handleDropRumbo(zone, idx);
            });
          });
          function handleDropRumbo(zone, idx) {
            const correct = rumbos[idx].name === draggedText;
            // Overlay label
            const overlay = document.getElementById('labels-overlay');
            const svgRect = zone.getBoundingClientRect();
            const parentRect = overlay.parentElement.getBoundingClientRect();
            const x = svgRect.left - parentRect.left + svgRect.width/2;
            const y = svgRect.top - parentRect.top + svgRect.height/2;
            // Remove previous label for this pos
            overlay.querySelectorAll(`[data-label-pos="${idx}"]`).forEach(n => n.remove());
            // Add label
            const label = document.createElement('div');
            label.textContent = draggedText;
            label.setAttribute('data-label-pos', idx);
            label.className = `absolute text-base font-bold px-2 py-2 rounded-lg pointer-events-none shadow`;
            label.style.left = `${x-60}px`;
            label.style.top = `${y-32}px`;
            label.style.width = '120px';
            label.style.height = '64px';
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.justifyContent = 'center';
            label.style.textAlign = 'center';
            label.style.background = correct ? '#22c55e' : '#ef4444';
            label.style.color = '#fff';
            label.style.transition = 'background 0.2s';
            overlay.appendChild(label);
            // Efecto shake si es incorrecto
            if (!correct) {
              label.animate([
                { transform: 'translateX(0px)' },
                { transform: 'translateX(-12px)' },
                { transform: 'translateX(12px)' },
                { transform: 'translateX(-12px)' },
                { transform: 'translateX(12px)' },
                { transform: 'translateX(0px)' }
              ], { duration: 400, easing: 'ease' });
              // Volver el nombre al menú después del shake
              setTimeout(() => {
                overlay.removeChild(label);
                // Si el nombre no está ya en la lista, lo agrego de nuevo
                if (!document.querySelector(`#rumbos-list li[data-rumbo='${draggedText}']`)) {
                  const li = document.createElement('li');
                  li.textContent = draggedText;
                  li.setAttribute('draggable', 'true');
                  li.setAttribute('data-rumbo', draggedText);
                  li.className = 'draggable-rumbo cursor-move bg-slate-100 rounded px-4 py-4 shadow hover:bg-sky-100 transition text-lg touch-manipulation';
                  document.getElementById('rumbos-list').appendChild(li);
                  // Reasignar eventos drag y touch
                  li.addEventListener('dragstart', e => {
                    dragged = li;
                    draggedText = li.getAttribute('data-rumbo');
                    setTimeout(() => li.classList.add('opacity-50'), 0);
                  });
                  li.addEventListener('dragend', e => {
                    dragged = null;
                    draggedText = '';
                    li.classList.remove('opacity-50');
                  });
                  li.addEventListener('touchstart', e => {
                    dragged = li;
                    draggedText = li.getAttribute('data-rumbo');
                    li.classList.add('opacity-50');
                    e.stopPropagation();
                  });
                  li.addEventListener('touchend', e => {
                    dragged = null;
                    draggedText = '';
                    li.classList.remove('opacity-50');
                    e.stopPropagation();
                  });
                }
              }, 420);
            } else {
              // Si es correcto, deshabilitar el drop para esa zona
              zone.style.pointerEvents = 'none';
              dragged.setAttribute('draggable', 'false');
              dragged.classList.add('line-through', 'opacity-40');
            }
          }
        }

        // --- Ejercicio de maniobras ---
        if (topicSlug === 'maniobras') {
          const terms = [
            {
              term: 'Orzar o Ceñir',
              desc: 'Maniobra en la que la embarcación gira su proa acercándola a la dirección desde donde sopla el viento.'
            },
            {
              term: 'Derivar',
              desc: 'Ocurre cuando el barco orienta su proa alejándola del viento, separándose del eje del viento.'
            },
            {
              term: 'Portar',
              desc: 'Situación en la que las velas están bien expuestas al viento y trabajan eficientemente, navegando con viento favorable desde la popa o alrededores.'
            },
            {
              term: 'Amurado a estribor / Amurado a babor',
              desc: 'Condición en la que el viento llega por el lado derecho (estribor) o por el lado izquierdo (babor) de la embarcación.'
            },
            {
              term: 'Virar',
              desc: 'Maniobra que implica cambiar de rumbo cruzando el eje del viento, haciendo que el viento pase de una banda a la otra.'
            }
          ];
          // Mezclar términos y descripciones para el modo "flashcard"
          let remaining = [...terms];
          let current = null;
          let correctCount = 0;
          let total = terms.length;
          function nextCard() {
            if (remaining.length === 0) {
              document.getElementById('exercise-content').innerHTML = `<div class='flex flex-col items-center justify-center py-16'><h2 class='text-2xl font-bold text-green-700 mb-4'>¡Ejercicio completado!</h2><p class='text-lg text-slate-700'>Respondiste correctamente ${correctCount} de ${total}.</p></div>`;
              return;
            }
            // Elegir aleatorio
            const idx = Math.floor(Math.random() * remaining.length);
            current = remaining[idx];
            // Opciones mezcladas
            const options = [current.term, ...terms.filter(t => t.term !== current.term).map(t => t.term)].sort(() => Math.random() - 0.5);
            document.getElementById('exercise-content').innerHTML = `
              <style>
                .maniobras-card { background: #e0f2fe; border-radius: 22px; border: 2.5px dashed #0ea5e9; padding: 2.5rem 1.5rem 1.5rem 1.5rem; max-width: 600px; margin: 2rem auto 0 auto; box-shadow: 0 2px 16px #0001; }
                .maniobras-card h3 { color: #0369a1; font-size: 1.5rem; font-weight: 800; margin-bottom: 1.5rem; letter-spacing: 0.01em; text-align: center; }
                .maniobras-card .desc { background: #bae6fd; border-radius: 18px; padding: 1.3rem 1.6rem; font-size: 1.13rem; color: #0c4a6e; margin-bottom: 2rem; box-shadow: 0 2px 8px #0001; font-weight: 600; border: 2.5px solid #0ea5e9; }
                .maniobras-options { display: flex; flex-direction: column; gap: 1.2rem; }
                .maniobras-option { background: #fff; border-radius: 14px; padding: 1.2rem 1.7rem; font-size: 1.13rem; color: #0369a1; box-shadow: 0 2px 8px #0001; cursor: pointer; border: 2.5px solid #0ea5e9; font-weight: 600; transition: border 0.2s, background 0.2s; }
                .maniobras-option.selected { border-color: #38bdf8; background: #e0f2fe; }
                .maniobras-option.correct { border-color: #22c55e; background: #dcfce7; }
                .maniobras-option.incorrect { border-color: #ef4444; background: #fee2e2; }
                .maniobras-progress { color: #0369a1; font-weight: 600; margin-top: 1.2rem; text-align: center; }
              </style>
              <div class='maniobras-card'>
                <h3>Tap para unir el término correcto con la descripción</h3>
                <div class='desc'>${current.desc}</div>
                <div class='maniobras-options'>
                  ${options.map(opt => `<div class='maniobras-option' data-term='${opt}'>${opt}</div>`).join('')}
                </div>
                <div class='maniobras-progress'>${remaining.length} de ${total} restantes</div>
                <div id='maniobras-feedback' class='mt-4 text-center text-base'></div>
              </div>
            `;
            // Interacción tap/click
            document.querySelectorAll('.maniobras-option').forEach(optEl => {
              optEl.addEventListener('click', () => {
                document.querySelectorAll('.maniobras-option').forEach(e => e.classList.remove('selected'));
                optEl.classList.add('selected');
                setTimeout(() => {
                  if (optEl.getAttribute('data-term') === current.term) {
                    optEl.classList.add('correct');
                    document.getElementById('maniobras-feedback').textContent = '¡Correcto!';
                    document.getElementById('maniobras-feedback').className = 'mt-4 text-center text-base text-green-600';
                    correctCount++;
                    setTimeout(() => {
                      remaining = remaining.filter(t => t.term !== current.term);
                      nextCard();
                    }, 900);
                  } else {
                    optEl.classList.add('incorrect');
                    document.getElementById('maniobras-feedback').textContent = 'Incorrecto. Intenta de nuevo.';
                    document.getElementById('maniobras-feedback').className = 'mt-4 text-center text-base text-red-600';
                    setTimeout(() => {
                      optEl.classList.remove('incorrect', 'selected');
                      document.getElementById('maniobras-feedback').textContent = '';
                    }, 900);
                  }
                }, 200);
              });
            });
          }
          nextCard();
        }

      } else {
        if (exercisePageTitleElement) exercisePageTitleElement.textContent = 'Error';
        if (topicHeadingElement) topicHeadingElement.textContent = 'Tema de ejercicio no especificado';
        if (descriptionElement) descriptionElement.textContent = 'No se pudo cargar el ejercicio. Por favor, vuelve al manual y selecciona un tema.';
      }
    });
  </script>
</body>
</html>